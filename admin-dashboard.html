<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | Pearl Essence</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --bg: #fbf7f3;
      --card: #ffffff;
      --text: #333333;
      --text-muted: #7a7a7a;
      --gold: #d4af37;
      --gold-light: #f1e5c9;
      --accent: #e9e2da;
      --border: #eee5d7;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.1);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background: linear-gradient(135deg, #fffaf6 0%, #fff7f0 100%);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-img {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      object-fit: cover;
    }

    .logo-text {
      font-weight: 700;
      color: var(--gold);
      font-size: 18px;
      letter-spacing: 0.5px;
    }

    .page-title {
      font-family: 'Playfair Display', serif;
      color: var(--gold);
      font-size: 28px;
      font-weight: 600;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .btn {
      background: var(--gold);
      border: none;
      color: white;
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn:hover {
      background: #c19b2c;
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn.secondary {
      background: #f5f5f5;
      color: #555;
    }

    .btn.secondary:hover {
      background: #e8e8e8;
    }

    .btn.danger {
      background: var(--danger);
    }

    .btn.danger:hover {
      background: #d32f2f;
    }

    .btn-small-glossy {
      padding: 6px 10px;
      background: linear-gradient(135deg, #f5f5f5, #e8e8e8);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      border: 1px solid rgba(255,255,255,0.5);
      font-size: 14px;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: var(--card);
      padding: 20px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
    }

    .card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--gold);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 5px;
    }

    .stat-label {
      color: var(--text-muted);
      font-size: 14px;
    }

    .section {
      margin-bottom: 30px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 22px;
      font-weight: 600;
      color: var(--gold);
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .table th, .table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .table th {
      background-color: var(--gold-light);
      font-weight: 600;
    }

    .table tr:hover {
      background-color: rgba(212, 175, 55, 0.05);
    }

    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-active {
      background-color: rgba(76, 175, 80, 0.15);
      color: var(--success);
    }

    .status-pending {
      background-color: rgba(255, 152, 0, 0.15);
      color: var(--warning);
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      display: none;
    }

    .modal {
      background: white;
      border-radius: var(--radius-lg);
      padding: 24px;
      width: 100%;
      max-width: 500px;
      box-shadow: var(--shadow-lg);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--gold);
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-muted);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
    }

    .form-control {
      width: 100%;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      font-size: 16px;
      transition: var(--transition);
    }

    .form-control:focus {
      border-color: var(--gold);
      box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
      outline: none;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 20px;
    }

    .alert {
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      margin-bottom: 20px;
      display: none;
    }

    .alert-success {
      background-color: rgba(76, 175, 80, 0.15);
      color: var(--success);
      border: 1px solid rgba(76, 175, 80, 0.2);
    }

    .alert-error {
      background-color: rgba(244, 67, 54, 0.15);
      color: var(--danger);
      border: 1px solid rgba(244, 67, 54, 0.2);
    }

    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .table {
        display: block;
        overflow-x: auto;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <img src="images/logo.png.jpg" alt="logo" class="logo-img">
        <div class="logo-text">Pearl Essence</div>
      </div>
      <h1 class="page-title">Admin Dashboard</h1>
      <div class="header-actions">
        <span id="adminWelcome">Welcome, Admin</span>
        <button class="btn secondary btn-small-glossy" onclick="window.location.href='index.html'">
          <i class="fas fa-home"></i> Back to Home
        </button>
        <button class="btn secondary" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </header>

    <div class="alert alert-success" id="successAlert"></div>
    <div class="alert alert-error" id="errorAlert"></div>

    <div class="dashboard-grid">
      <div class="card">
        <div class="card-title">
          <i class="fas fa-shopping-bag"></i> Today's Orders
        </div>
        <div class="stat-value" id="ordersCount">0</div>
        <div class="stat-label">Orders placed today</div>
      </div>

      <div class="card">
        <div class="card-title">
          <i class="fas fa-chart-line"></i> Total Sales
        </div>
        <div class="stat-value" id="salesTotal">$0.00</div>
        <div class="stat-label">Revenue today</div>
      </div>

      <div class="card">
        <div class="card-title">
          <i class="fas fa-users"></i> Active Agents
        </div>
        <div class="stat-value" id="agentsCount">0</div>
        <div class="stat-label">Delivery agents available</div>
      </div>

      <div class="card">
        <div class="card-title">
          <i class="fas fa-box"></i> Products
        </div>
        <div class="stat-value" id="productsCount">0</div>
        <div class="stat-label">Total products in stock</div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <h2 class="section-title">Order Management</h2>
        <button class="btn" id="refreshOrdersBtn">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
      </div>
      <div class="card">
        <div class="table-responsive">
          <table class="table" id="ordersTable">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Amount (TZS)</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Orders will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <h2 class="section-title">Agent Management</h2>
        <button class="btn" id="addAgentBtn">
          <i class="fas fa-plus"></i> Add Agent
        </button>
      </div>
      <div class="card">
        <div class="table-responsive">
          <table class="table" id="agentsTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>Area</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Agents will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <h2 class="section-title">Product Management</h2>
        <button class="btn" id="addProductBtn">
          <i class="fas fa-plus"></i> Add Product
        </button>
      </div>
      <div class="card">
        <div class="table-responsive">
          <table class="table" id="productsTable">
            <thead>
              <tr>
                <th>Product</th>
                <th>Price (TZS)</th>
                <th>Stock</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Products will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Agent Modal -->
  <div class="modal-backdrop" id="agentModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="agentModalTitle">Add New Agent</h3>
        <button class="close-modal" id="closeAgentModal">&times;</button>
      </div>
      <form id="agentForm">
        <input type="hidden" id="agentId">
        <div class="form-group">
          <label for="agentName" class="form-label">Full Name</label>
          <input type="text" id="agentName" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="agentPhone" class="form-label">Phone Number</label>
          <input type="tel" id="agentPhone" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="agentArea" class="form-label">Service Area</label>
          <input type="text" id="agentArea" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="agentStatus" class="form-label">Status</label>
          <select id="agentStatus" class="form-control" required>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
        <div class="form-actions">
          <button type="button" class="btn secondary" id="cancelAgentBtn">Cancel</button>
          <button type="submit" class="btn">Save Agent</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Product Modal -->
  <div class="modal-backdrop" id="productModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="productModalTitle">Add New Product</h3>
        <button class="close-modal" id="closeProductModal">&times;</button>
      </div>
      <form id="productForm">
        <input type="hidden" id="productId">
        <div class="form-group">
          <label for="productName" class="form-label">Product Name</label>
          <input type="text" id="productName" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="productPrice" class="form-label">Price (TZS)</label>
          <input type="number" id="productPrice" class="form-control" step="0.01" min="0" required>
        </div>
        <div class="form-group">
          <label for="productStock" class="form-label">Stock Quantity</label>
          <input type="number" id="productStock" class="form-control" min="0" required>
        </div>
        <div class="form-group">
          <label for="productStatus" class="form-label">Status</label>
          <select id="productStatus" class="form-control" required>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
        <div class="form-actions">
          <button type="button" class="btn secondary" id="cancelProductBtn">Cancel</button>
          <button type="submit" class="btn">Save Product</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Admin authentication system
    const ADMIN_CODE = "PEARL2024"; // In production, this should be stored in environment variables
    const AUTH_KEY = 'pe_admin_auth';
    
    // Check if already authenticated
    function checkAuth() {
      const auth = localStorage.getItem(AUTH_KEY);
      if (!auth) {
        window.location.href = "admin-login.html";
        return false;
      }
      
      const { timestamp, code } = JSON.parse(auth);
      
      // Check if session is still valid (8 hours)
      if (Date.now() - timestamp > 8 * 60 * 60 * 1000 || code !== ADMIN_CODE) {
        localStorage.removeItem(AUTH_KEY);
        window.location.href = "admin-login.html";
        return false;
      }
      
      return true;
    }
    
    // Check authentication when dashboard loads
    if (!checkAuth()) {
      // Redirect to login page
      // The redirect happens in the checkAdminAuth function
    }

    // Periodic session re-check (every 5 minutes)
    setInterval(() => {
      if (!checkAuth()) {
        // force logout and redirect handled inside checkAuth
      }
    }, 5 * 60 * 1000);
    
    // Protect UI actions: ensure elements exist before adding listeners
    function safeAddListener(id, event, handler){ const el = document.getElementById(id); if(el) el.addEventListener(event, handler); }
    
    // Logout functionality
    safeAddListener('logoutBtn', 'click', function() {
      localStorage.removeItem(AUTH_KEY);
      window.location.href = 'admin-login.html';
    });

    // Data storage keys
    const ORDERS_KEY = 'pe_orders';
    const AGENTS_KEY = 'pe_agents';
    const PRODUCTS_KEY = 'pe_products';

    // Initialize data
    function initData() {
      // Initialize orders if not exists
      if (!localStorage.getItem(ORDERS_KEY)) {
        const today = new Date();
        const sampleOrders = [
          {
            id: 'ORD-1001',
            customer: 'Emily Wilson',
            amount: 276000,
            status: 'pending',
            date: today.toISOString().split('T')[0],
            items: ['Pearl Serum']
          },
          {
            id: 'ORD-1002',
            customer: 'David Lee',
            amount: 391000,
            status: 'completed',
            date: today.toISOString().split('T')[0],
            items: ['Silk Moisturizer', 'Pearl Essence Soap']
          }
        ];
        localStorage.setItem(ORDERS_KEY, JSON.stringify(sampleOrders));
      }

      // Initialize agents if not exists
      if (!localStorage.getItem(AGENTS_KEY)) {
        const sampleAgents = [
          {
            id: '1',
            name: 'Jane Doe',
            phone: '+255 712 345 678',
            area: 'Dar es Salaam',
            status: 'active'
          },
          {
            id: '2',
            name: 'John Smith',
            phone: '+255 754 987 654',
            area: 'Arusha',
            status: 'active'
          }
        ];
        localStorage.setItem(AGENTS_KEY, JSON.stringify(sampleAgents));
      }

      // Initialize products if not exists
      if (!localStorage.getItem(PRODUCTS_KEY)) {
        const sampleProducts = [
          {
            id: '1',
            name: 'Pearl Serum',
            price: 276000,
            stock: 50,
            status: 'active'
          },
          {
            id: '2',
            name: 'Silk Moisturizer',
            price: 195500,
            stock: 75,
            status: 'active'
          },
          {
            id: '3',
            name: 'Pearl Essence Soap',
            price: 57477,
            stock: 100,
            status: 'active'
          }
        ];
        localStorage.setItem(PRODUCTS_KEY, JSON.stringify(sampleProducts));
      }
    }

    // Load data from localStorage
    function loadData(key) {
      return JSON.parse(localStorage.getItem(key)) || [];
    }

    // Save data to localStorage
    function saveData(key, data) {
      localStorage.setItem(key, JSON.stringify(data));
    }

    // Show alert message
    function showAlert(message, type = 'success') {
      const alert = document.getElementById(type === 'success' ? 'successAlert' : 'errorAlert');
      alert.textContent = message;
      alert.style.display = 'block';
      
      setTimeout(() => {
        alert.style.display = 'none';
      }, 3000);
    }

    // Update dashboard stats
    function updateStats() {
      const orders = loadData(ORDERS_KEY);
      const agents = loadData(AGENTS_KEY);
      const products = loadData(PRODUCTS_KEY);
      
      // Today's date
      const today = new Date().toISOString().split('T')[0];
      
      // Today's orders
      const todaysOrders = orders.filter(order => order.date === today);
      document.getElementById('ordersCount').textContent = todaysOrders.length;
      
      // Today's sales
      const todaysSales = todaysOrders.reduce((total, order) => total + order.amount, 0);
      document.getElementById('salesTotal').textContent = `TZS ${Math.round(todaysSales).toLocaleString()}`;
      
      // Active agents
      const activeAgents = agents.filter(agent => agent.status === 'active');
      document.getElementById('agentsCount').textContent = activeAgents.length;
      
      // Products count
      document.getElementById('productsCount').textContent = products.length;
    }

    // Render orders table
    function renderOrders() {
      const orders = loadData(ORDERS_KEY);
      const tbody = document.querySelector('#ordersTable tbody');
      tbody.innerHTML = '';
      
      // Today's date
      const today = new Date().toISOString().split('T')[0];
      
      // Filter today's orders
      const todaysOrders = orders.filter(order => order.date === today);
      
      if (todaysOrders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No orders today</td></tr>';
        return;
      }
      
      todaysOrders.forEach(order => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${order.id}</td>
          <td>${order.customer}</td>
          <td>TZS ${order.amount.toLocaleString()}</td>
          <td><span class="status-badge status-${order.status}">${order.status}</span></td>
          <td>${order.date}</td>
          <td class="action-buttons">
            <button class="btn secondary" onclick="completeOrder('${order.id}')">
              <i class="fas fa-check"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Complete an order
    function completeOrder(orderId) {
      const orders = loadData(ORDERS_KEY);
      const orderIndex = orders.findIndex(order => order.id === orderId);
      
      if (orderIndex !== -1) {
        orders[orderIndex].status = 'completed';
        saveData(ORDERS_KEY, orders);
        renderOrders();
        updateStats();
        showAlert('Order marked as completed');
      }
    }

    // Render agents table
    function renderAgents() {
      const agents = loadData(AGENTS_KEY);
      const tbody = document.querySelector('#agentsTable tbody');
      tbody.innerHTML = '';
      
      if (agents.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No agents found</td></tr>';
        return;
      }
      
      agents.forEach(agent => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${agent.name}</td>
          <td>${agent.phone}</td>
          <td>${agent.area}</td>
          <td><span class="status-badge status-${agent.status}">${agent.status}</span></td>
          <td class="action-buttons">
            <button class="btn secondary" onclick="editAgent('${agent.id}')">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn danger" onclick="deleteAgent('${agent.id}')">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Render products table
    function renderProducts() {
      const products = loadData(PRODUCTS_KEY);
      const tbody = document.querySelector('#productsTable tbody');
      tbody.innerHTML = '';
      
      if (products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No products found</td></tr>';
        return;
      }
      
      products.forEach(product => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${product.name}</td>
          <td>TZS ${product.price.toLocaleString()}</td>
          <td>${product.stock}</td>
          <td><span class="status-badge status-${product.status}">${product.status}</span></td>
          <td class="action-buttons">
            <button class="btn secondary" onclick="editProduct('${product.id}')">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn danger" onclick="deleteProduct('${product.id}')">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Agent modal functions
    function openAgentModal(agentId = null) {
      const modal = document.getElementById('agentModal');
      const title = document.getElementById('agentModalTitle');
      const form = document.getElementById('agentForm');
      
      if (agentId) {
        // Edit mode
        title.textContent = 'Edit Agent';
        const agents = loadData(AGENTS_KEY);
        const agent = agents.find(a => a.id === agentId);
        
        if (agent) {
          document.getElementById('agentId').value = agent.id;
          document.getElementById('agentName').value = agent.name;
          document.getElementById('agentPhone').value = agent.phone;
          document.getElementById('agentArea').value = agent.area;
          document.getElementById('agentStatus').value = agent.status;
        }
      } else {
        // Add mode
        title.textContent = 'Add New Agent';
        form.reset();
        document.getElementById('agentId').value = '';
      }
      
      modal.style.display = 'flex';
    }

    function closeAgentModal() {
      document.getElementById('agentModal').style.display = 'none';
    }

    // Product modal functions
    function openProductModal(productId = null) {
      const modal = document.getElementById('productModal');
      const title = document.getElementById('productModalTitle');
      const form = document.getElementById('productForm');
      
      if (productId) {
        // Edit mode
        title.textContent = 'Edit Product';
        const products = loadData(PRODUCTS_KEY);
        const product = products.find(p => p.id === productId);
        
        if (product) {
          document.getElementById('productId').value = product.id;
          document.getElementById('productName').value = product.name;
          document.getElementById('productPrice').value = product.price;
          document.getElementById('productStock').value = product.stock;
          document.getElementById('productStatus').value = product.status;
        }
      } else {
        // Add mode
        title.textContent = 'Add New Product';
        form.reset();
        document.getElementById('productId').value = '';
      }
      
      modal.style.display = 'flex';
    }

    function closeProductModal() {
      document.getElementById('productModal').style.display = 'none';
    }

    // Save agent
    function saveAgent(e) {
      e.preventDefault();
      
      const agentId = document.getElementById('agentId').value;
      const name = document.getElementById('agentName').value;
      const phone = document.getElementById('agentPhone').value;
      const area = document.getElementById('agentArea').value;
      const status = document.getElementById('agentStatus').value;
      
      const agents = loadData(AGENTS_KEY);
      
      if (agentId) {
        // Update existing agent
        const index = agents.findIndex(a => a.id === agentId);
        if (index !== -1) {
          agents[index] = { id: agentId, name, phone, area, status };
          showAlert('Agent updated successfully');
        }
      } else {
        // Add new agent
        const newId = Date.now().toString();
        agents.push({ id: newId, name, phone, area, status });
        showAlert('Agent added successfully');
      }
      
      saveData(AGENTS_KEY, agents);
      closeAgentModal();
      renderAgents();
      updateStats();
    }

    // Save product
    function saveProduct(e) {
      e.preventDefault();
      
      const productId = document.getElementById('productId').value;
      const name = document.getElementById('productName').value;
      const price = parseFloat(document.getElementById('productPrice').value);
      const stock = parseInt(document.getElementById('productStock').value);
      const status = document.getElementById('productStatus').value;
      
      const products = loadData(PRODUCTS_KEY);
      
      if (productId) {
        // Update existing product
        const index = products.findIndex(p => p.id === productId);
        if (index !== -1) {
          products[index] = { id: productId, name, price, stock, status };
          showAlert('Product updated successfully');
        }
      } else {
        // Add new product
        const newId = Date.now().toString();
        products.push({ id: newId, name, price, stock, status });
        showAlert('Product added successfully');
      }
      
      saveData(PRODUCTS_KEY, products);
      closeProductModal();
      renderProducts();
      updateStats();
    }

    // Edit agent
    function editAgent(agentId) {
      openAgentModal(agentId);
    }

    // Edit product
    function editProduct(productId) {
      openProductModal(productId);
    }

    // Delete agent
    function deleteAgent(agentId) {
      if (confirm('Are you sure you want to delete this agent?')) {
        const agents = loadData(AGENTS_KEY);
        const filteredAgents = agents.filter(agent => agent.id !== agentId);
        saveData(AGENTS_KEY, filteredAgents);
        renderAgents();
        updateStats();
        showAlert('Agent deleted successfully');
      }
    }

    // Delete product
    function deleteProduct(productId) {
      if (confirm('Are you sure you want to delete this product?')) {
        const products = loadData(PRODUCTS_KEY);
        const filteredProducts = products.filter(product => product.id !== productId);
        saveData(PRODUCTS_KEY, filteredProducts);
        renderProducts();
        updateStats();
        showAlert('Product deleted successfully');
      }
    }

    // Refresh orders
    function refreshOrders() {
      // In a real application, this would fetch new data from a server
      // For this demo, we'll just re-render the existing data
      renderOrders();
      updateStats();
      showAlert('Orders refreshed');
    }

    // Initialize the application
    function initApp() {
      initData();
      updateStats();
      renderOrders();
      renderAgents();
      renderProducts();
      
      // Event listeners
      document.getElementById('addAgentBtn').addEventListener('click', () => openAgentModal());
      document.getElementById('addProductBtn').addEventListener('click', () => openProductModal());
      document.getElementById('refreshOrdersBtn').addEventListener('click', refreshOrders);
      
      document.getElementById('closeAgentModal').addEventListener('click', closeAgentModal);
      document.getElementById('cancelAgentBtn').addEventListener('click', closeAgentModal);
      document.getElementById('agentForm').addEventListener('submit', saveAgent);
      
      document.getElementById('closeProductModal').addEventListener('click', closeProductModal);
      document.getElementById('cancelProductBtn').addEventListener('click', closeProductModal);
      document.getElementById('productForm').addEventListener('submit', saveProduct);
      
      // Close modals when clicking outside
      document.querySelectorAll('.modal-backdrop').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.style.display = 'none';
          }
        });
      });
    }

    // Initialize the app when the DOM is loaded
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>