<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pearl Essence | Agents & Community</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Montserrat:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* Color Variables and Global Styles */
    :root {
      /* Light Mode Colors */
      --gold: #D4AF37;
      --pink: #FF9F9F;
      --black: #1A1A1A;
      --bg-light: #FFF9F0;
      --card-light: #FFFFFF;
      --text-light: #333333;
      --input-light: #f5f5f5;
      --border-light: #e0e0e0;
      --chat-bg-light: #fefefe;
      --user-bubble-light: #d4af37;
      --user-text-light: #ffffff;
      --assistant-bubble-light: #e5e5e5;
      --assistant-text-light: #333333;
      --shadow-light: rgba(0, 0, 0, 0.1);
      
      /* Dark Mode Colors */
      --bg-dark: #1A1A1A;
      --card-dark: #2D2D2D;
      --text-dark: #F0F0F0;
      --input-dark: #3a3a3a;
      --border-dark: #444444;
      --chat-bg-dark: #222222;
      --user-bubble-dark: #d4af37;
      --user-text-dark: #ffffff;
      --assistant-bubble-dark: #3a3a3a;
      --assistant-text-dark: #F0F0F0;
      --shadow-dark: rgba(255, 255, 255, 0.08);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background-color: var(--bg-light);
      color: var(--text-light);
      overflow-x: hidden;
    }

    body.dark-mode {
      background-color: var(--bg-dark);
      color: var(--text-dark);
    }

    /* Navigation Bar */
    .nav-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 15px 0;
      background: rgba(255, 255, 255, 0.15);
      -webkit-backdrop-filter: blur(12px);
      backdrop-filter: blur(12px);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }

    .dark-mode .nav-container {
      background: rgba(26, 26, 26, 0.15);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .nav-logo {
      margin-left: 30px;
      margin-right: 20px;
      display: flex;
      align-items: center;
    }

    .nav-logo-img {
      height: 45px;
      width: 45px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 2px solid var(--gold);
    }

    .nav-menu {
      display: flex;
      gap: 30px;
    }

    .nav-link {
      color: var(--text-light);
      text-decoration: none;
      font-weight: 500;
      font-size: 1rem;
      position: relative;
      padding: 5px 0;
      transition: color 0.3s ease;
    }

    .dark-mode .nav-link {
      color: var(--text-dark);
    }

    .nav-link::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 2px;
      background: var(--gold);
      transition: width 0.3s ease;
    }

    .nav-link:hover::after {
      width: 100%;
    }

    .nav-link:hover {
      color: var(--gold);
    }

    /* Page Layout */
    .main-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 40px;
      padding: 100px 20px 40px;
      min-height: 100vh;
      flex-wrap: wrap;
    }

    @media (min-width: 1024px) {
      .main-container {
        flex-wrap: nowrap;
      }
    }

    /* Agent and Community Showcase */
    .community-container {
      width: 100%;
      max-width: 800px;
      display: block;
    }

    .section-title {
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      font-size: 2.5rem;
      color: var(--gold);
      text-align: center;
      margin-bottom: 10px;
    }

    .section-subtitle {
      font-weight: 300;
      font-size: 1rem;
      color: #666;
      text-align: center;
      margin-bottom: 40px;
    }

    .dark-mode .section-subtitle {
      color: #aaa;
    }

    .agent-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .agent-card {
      background-color: var(--card-light);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      align-items: center;
      box-shadow: 0 4px 15px var(--shadow-light);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      border: 2px solid transparent;
      position: relative;
    }

    .dark-mode .agent-card {
      background-color: var(--card-dark);
      box-shadow: 0 4px 15px var(--shadow-dark);
    }

    .agent-card.selected {
      border-color: var(--gold);
      box-shadow: 0 4px 20px rgba(212, 175, 55, 0.4);
    }

    .agent-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px var(--shadow-light);
    }

    .dark-mode .agent-card:hover {
      box-shadow: 0 6px 20px var(--shadow-dark);
    }

    .agent-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--gold), #c19a6b);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      color: white;
      font-weight: 600;
      font-size: 20px;
      flex-shrink: 0;
      overflow: hidden;
    }

    .agent-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .agent-details {
      flex-grow: 1;
    }

    .agent-name {
      font-weight: 700;
      margin: 0 0 5px;
      font-size: 1.1rem;
    }

    .agent-info {
      font-size: 13px;
      color: #666;
      margin: 0 0 5px;
    }

    .dark-mode .agent-info {
      color: #aaa;
    }

    .agent-location {
      font-size: 12px;
      color: #888;
      margin: 0;
      display: flex;
      align-items: center;
    }

    .dark-mode .agent-location {
      color: #999;
    }

    .agent-location i {
      margin-right: 5px;
      font-size: 11px;
    }

    .agent-rating {
      color: var(--gold);
      font-weight: 600;
    }

    .agent-availability {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 10px;
      flex-shrink: 0;
    }

    .available {
      background-color: rgba(162, 237, 187, 0.2);
      color: #3b8754;
    }

    .unavailable {
      background-color: rgba(255, 159, 159, 0.2);
      color: #9b2c2c;
    }

    /* Agent contact actions */
    .agent-contact {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
    }

    .phone-link {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: rgba(76, 175, 80, 0.1);
      color: #4CAF50;
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .phone-link:hover {
      background-color: #4CAF50;
      color: white;
      transform: scale(1.1);
    }

    /* Chat Container Styles */
    .chat-container {
      width: 100%;
      max-width: 800px;
      height: 70vh;
      max-height: 800px;
      display: none;
      flex-direction: column;
      background-color: var(--card-light);
      border-radius: 12px;
      box-shadow: 0 10px 30px var(--shadow-light);
      transition: all 0.3s ease;
    }

    .dark-mode .chat-container {
      background-color: var(--card-dark);
      box-shadow: 0 10px 30px var(--shadow-dark);
    }

    .chat-header {
      background-color: var(--gold);
      color: white;
      padding: 15px 20px;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-header-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .chat-header .chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      color: var(--gold);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      overflow: hidden;
    }

    .chat-header .chat-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .chat-header .header-text h3 {
      margin: 0;
      font-size: 1.2rem;
    }

    .chat-header .header-text p {
      margin: 0;
      font-size: 0.8rem;
      font-weight: 300;
      opacity: 0.8;
    }

    .chat-header-actions {
      display: flex;
      gap: 10px;
    }

    .chat-action-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .chat-action-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .chat-box {
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background-color: var(--chat-bg-light);
      border-bottom: 1px solid var(--border-light);
    }

    .dark-mode .chat-box {
      background-color: var(--chat-bg-dark);
      border-color: var(--border-dark);
    }

    .message-container {
      display: flex;
    }

    .user-message {
      justify-content: flex-end;
    }

    .assistant-message {
      justify-content: flex-start;
    }

    .message-bubble {
      padding: 12px 18px;
      border-radius: 20px;
      max-width: 80%;
      font-size: 0.95rem;
      line-height: 1.4;
      word-wrap: break-word;
      white-space: pre-wrap;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .user-message .message-bubble {
      background-color: var(--user-bubble-light);
      color: var(--user-text-light);
      border-bottom-right-radius: 4px;
    }

    .dark-mode .user-message .message-bubble {
      background-color: var(--user-bubble-dark);
      color: var(--user-text-dark);
    }

    .assistant-message .message-bubble {
      background-color: var(--assistant-bubble-light);
      color: var(--assistant-text-light);
      border-bottom-left-radius: 4px;
    }

    .dark-mode .assistant-message .message-bubble {
      background-color: var(--assistant-bubble-dark);
      color: var(--assistant-text-dark);
    }

    .chat-input-container {
      display: flex;
      padding: 15px;
      border-top: 1px solid var(--border-light);
      background-color: var(--card-light);
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
    }

    .dark-mode .chat-input-container {
      background-color: var(--card-dark);
      border-color: var(--border-dark);
    }

    #chat-input {
      flex-grow: 1;
      border: none;
      background-color: var(--input-light);
      border-radius: 20px;
      padding: 10px 15px;
      font-size: 1rem;
      color: var(--text-light);
      transition: background-color 0.3s ease;
    }

    .dark-mode #chat-input {
      background-color: var(--input-dark);
      color: var(--text-dark);
    }

    #chat-input:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
    }

    #send-btn {
      background-color: var(--gold);
      color: white;
      border: none;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      margin-left: 10px;
      cursor: pointer;
      transition: transform 0.2s ease, background-color 0.3s ease;
    }

    #send-btn:hover {
      background-color: #c19a6b;
      transform: scale(1.05);
    }

    .no-agents-message {
      text-align: center;
      color: #999;
      font-style: italic;
      margin-top: 20px;
    }

    /* Filter and Search Section */
    .filter-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .search-box {
      position: relative;
      flex-grow: 1;
      max-width: 300px;
    }

    .search-box input {
      width: 100%;
      padding: 10px 15px 10px 40px;
      border: 1px solid var(--border-light);
      border-radius: 20px;
      background-color: var(--card-light);
      color: var(--text-light);
      font-size: 0.9rem;
    }

    .dark-mode .search-box input {
      background-color: var(--card-dark);
      border-color: var(--border-dark);
      color: var(--text-dark);
    }

    .search-box i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #888;
    }

    .location-filter {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .location-filter select {
      padding: 10px 15px;
      border: 1px solid var(--border-light);
      border-radius: 20px;
      background-color: var(--card-light);
      color: var(--text-light);
      font-size: 0.9rem;
    }

    .dark-mode .location-filter select {
      background-color: var(--card-dark);
      border-color: var(--border-dark);
      color: var(--text-dark);
    }

    /* Agent Detail Modal */
    .agent-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .agent-modal-content {
      background: var(--card-light);
      padding: 30px;
      border-radius: 15px;
      max-width: 500px;
      width: 90%;
      position: relative;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      max-height: 90vh;
      overflow-y: auto;
    }

    .dark-mode .agent-modal-content {
      background: var(--card-dark);
    }

    .close-agent-modal {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-light);
    }

    .dark-mode .close-agent-modal {
      color: var(--text-dark);
    }

    .agent-modal-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
    }

    .agent-modal-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--gold), #c19a6b);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 24px;
      overflow: hidden;
    }

    .agent-modal-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .agent-modal-info h2 {
      margin-bottom: 5px;
      font-family: 'Playfair Display', serif;
      color: var(--gold);
    }

    .agent-modal-details {
      margin-top: 20px;
    }

    .agent-modal-detail {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .agent-modal-detail i {
      width: 24px;
      margin-right: 10px;
      color: var(--gold);
    }

    .agent-modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }

    .action-btn {
      padding: 10px 20px;
      border-radius: 20px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .action-btn.call {
      background-color: #4CAF50;
      color: white;
    }

    .action-btn.chat {
      background-color: var(--gold);
      color: white;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .main-container {
        padding: 90px 15px 30px;
      }
      
      .filter-section {
        flex-direction: column;
        align-items: stretch;
      }
      
      .search-box {
        max-width: 100%;
      }
      
      .agent-card {
        flex-direction: column;
        text-align: center;
        padding: 15px;
      }
      
      .agent-avatar {
        margin-right: 0;
        margin-bottom: 10px;
      }
      
      .agent-contact {
        justify-content: center;
      }
      
      .chat-container {
        height: 60vh;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <div class="nav-container">
    <div class="nav-logo">
      <a href="index.html">
        <img src="images/logo.png.jpg" alt="Pearl Essence Logo" class="nav-logo-img">
      </a>
    </div>
    <nav class="nav-menu">
      <a href="index.html" class="nav-link">Home</a>
      <a href="#" class="nav-link">Contact</a>
      <a href="agents&Community.html" class="nav-link current">Agents&Community</a>
      <a href="#" class="nav-link">Location</a>
      <button id="theme-toggle" class="nav-link" title="Toggle dark/light mode"><i class="fas fa-moon"></i></button>
    </nav>
  </div>

  <div class="main-container">
    <!-- Dynamic Chat Section -->
    <div class="chat-container">
      <div class="chat-header" id="chat-header">
        <div class="chat-header-info">
          <div class="chat-avatar" id="chat-agent-avatar">
            <!-- Will be populated by JavaScript -->
          </div>
          <div class="header-text">
            <h3 id="chat-agent-name">Agent Name</h3>
            <p id="chat-agent-status">Status</p>
          </div>
        </div>
        <div class="chat-header-actions">
          <button class="chat-action-btn" id="minimize-chat" title="Minimize Chat">
            <i class="fas fa-minus"></i>
          </button>
          <button class="chat-action-btn" id="close-chat" title="Close Chat">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="chat-box" id="chat-box">
        <!-- Chat messages will be dynamically added here by JavaScript -->
      </div>
      <div class="chat-input-container">
        <input type="text" id="chat-input" placeholder="Type a message...">
        <button id="send-btn" type="button" aria-label="Send message"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
    
    <!-- Agent and Community Showcase -->
    <div class="community-container" id="community-container">
      <h2 class="section-title">Meet Our Agents</h2>
      <p class="section-subtitle">Our experts are here to help you achieve your perfect glow.</p>
      
      <!-- Filter and Search Section -->
      <div class="filter-section">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="agent-search" placeholder="Search agents...">
        </div>
        <div class="location-filter">
          <label for="location-filter">Filter by location:</label>
          <select id="location-filter">
            <option value="all">All Locations</option>
            <option value="kinondoni">Kinondoni</option>
            <option value="ilala">Ilala</option>
            <option value="temeke">Temeke</option>
            <option value="ubungo">Ubungo</option>
            <option value="kigamboni">Kigamboni</option>
          </select>
        </div>
      </div>
      
      <div class="agent-list" id="agent-list">
        <!-- Agent cards will be dynamically added here by JavaScript -->
      </div>
    </div>
  </div>
  
  <!-- Agent Detail Modal -->
  <div class="agent-modal" id="agent-modal">
    <div class="agent-modal-content">
      <span class="close-agent-modal" id="close-agent-modal">&times;</span>
      <div class="agent-modal-header">
        <div class="agent-modal-avatar" id="modal-agent-avatar">
          <!-- Will be populated by JavaScript -->
        </div>
        <div class="agent-modal-info">
          <h2 id="modal-agent-name">Agent Name</h2>
          <p id="modal-agent-role">Skincare Specialist</p>
          <span class="agent-availability" id="modal-agent-availability">Online</span>
        </div>
      </div>
      <div class="agent-modal-details">
        <div class="agent-modal-detail">
          <i class="fas fa-map-marker-alt"></i>
          <span id="modal-agent-location">Location: Kinondoni, Dar es Salaam</span>
        </div>
        <div class="agent-modal-detail">
          <i class="fas fa-phone"></i>
          <span id="modal-agent-phone">Phone: +255 754 757 065</span>
        </div>
        <div class="agent-modal-detail">
          <i class="fas fa-star"></i>
          <span id="modal-agent-rating">Rating: 4.8/5</span>
        </div>
        <div class="agent-modal-detail">
          <i class="fas fa-user"></i>
          <span id="modal-agent-clients">Clients served: 120+</span>
        </div>
        <div class="agent-modal-detail">
          <i class="fas fa-clock"></i>
          <span id="modal-agent-response">Avg. response time: 15 minutes</span>
        </div>
      </div>
      <div class="agent-modal-actions">
        <a href="#" class="action-btn call" id="modal-call-btn">
          <i class="fas fa-phone"></i> Call Now
        </a>
        <button class="action-btn chat" id="modal-chat-btn">
          <i class="fas fa-comment"></i> Start Chat
        </button>
        <button class="action-btn" id="modal-login-btn" title="Login as this agent">
          <i class="fas fa-sign-in-alt"></i> Login as Agent
        </button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Theme Toggle
      const themeToggle = document.getElementById('theme-toggle');
      themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const isDarkMode = document.body.classList.contains('dark-mode');
        themeToggle.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        localStorage.setItem('darkMode', isDarkMode);
      });

      // Check for saved theme preference
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
      }

      // Load agents from shared localStorage seed (set by index.html) if present, otherwise fall back to these defaults
      const AGENTS_KEY = 'pe_agents_v1';
      function normalizeAgent(a, idx){
        const phones = Array.isArray(a.phone) ? a.phone : (a.phone ? [a.phone] : []);
        return {
          id: a.id !== undefined ? a.id : ('agent_' + (a.name ? a.name.replace(/\s+/g,'_') : idx)),
          name: a.name || ('Agent ' + (idx+1)),
          role: a.role || 'Skincare Specialist',
          rating: a.rating || 4.5,
          status: a.status || 'Available',
          avatar: a.avatar || '',
          photo: 'images/logo.png.jpg',
          location: a.location || a.area || '',
          phone: phones,
          clients: a.clients || 0,
          responseTime: a.responseTime || 'N/A'
        };
      }

      let agents = [];
      try{
        const stored = JSON.parse(localStorage.getItem(AGENTS_KEY) || 'null');
        if(stored && Array.isArray(stored) && stored.length){
          agents = stored.map((a, i) => normalizeAgent(a, i));
        }
      }catch(e){ agents = []; }

      if(!agents.length){
        // Raw fallback list
        const raw = [
          {name:'Mwanza', location:'Mwanza', phone:['+255628088887']},
          {name:'Kibaha', location:'Kibaha', phone:['+255677750964']},
          {name:'Mwanza Pasi Beach', location:'Mwanza Pasi Beach', phone:['+255659470706']},
          {name:'Wakela Ukonga', location:'Ukonga', phone:['+255765677758']},
          {name:'Zanzibar', location:'Zanzibar', phone:['+255621166461','+255753674879']},
          {name:'Kigoma', location:'Kigoma', phone:['+255683913227']},
          {name:'Mufindi', location:'Mufindi', phone:['+255622136179']},
          {name:'Morogoro', location:'Morogoro', phone:['+255754590704']},
          {name:'KKOO', location:'KKOO', phone:['+255712048043','+255755048043','+255655048043']},
          {name:'Wakala Mwenge', location:'Mwenge', phone:['+255620904888','+255757736910','+255714722358','+255714722358']},
          {name:'Sinza', location:'Sinza', phone:['+255719328328','+255744328328','+255622328328']},
          {name:'Wakala Kigamboni', location:'Kigamboni', phone:['+255715099216']},
          {name:'Musoma', location:'Musoma', phone:['+255621823888','+255719328328']},
          {name:'Tabora', location:'Tabora', phone:['+255678770000']},
          {name:'Simiyu', location:'Simiyu', phone:['+255755106173']},
          {name:'Tanga', location:'Tanga', phone:['+255759292929','+255629292929']},
          {name:'Dodoma', location:'Dodoma', phone:['+255685410410','+255712510510','+255656888419','+255763013335','+255714746278']},
          {name:'Bunju', location:'Bunju', phone:['+255684892888']},
          {name:'Kimara', location:'Kimara', phone:['+255754093093']},
          {name:'Kawe', location:'Kawe', phone:['+255622328328']},
          {name:'Mombasa (branch)', location:'Mombasa', phone:['+255683999111']},
          {name:'Wakala Bukoba', location:'Bukoba', phone:['+255764459291','+255714873848']},
          {name:'Mtwara/Mbeya', location:'Mtwara/Mbeya', phone:['+255627057583']},
          {name:'Songea', location:'Songea', phone:['+255678770000']},
          {name:'Iringa', location:'Iringa', phone:['+255719328328']},
          {name:'Mbeya', location:'Mbeya', phone:['+255759292929','+255629292929']},
          {name:'Wakala Arusha', location:'Arusha', phone:['+255652647225','+255742857066']},
          {name:'Wakaka Posta', location:'Dar es Salaam', phone:['+255694340688','+255767501841']},
          {name:'Wakaka Mbweni', location:'Mbweni', phone:['+255752275170']},
          {name:'Wakaka Maburushi', location:'Maburushi', phone:['+255755209941']},
          {name:'Wakaka Kinondoni', location:'Kinondoni', phone:['+255710940940']},
          {name:'Wakaka Kariakoo', location:'Kariakoo', phone:['+255715421929','+255652134003']},
          {name:'Wakaka Kkoo', location:'KKOO', phone:['+255788296801']},
          {name:'Wakaka Upanga', location:'Upanga', phone:['+255752275170']},
          {name:'Wakaka Tegeta', location:'Tegeta', phone:['+25574446567']},
          {name:'Wakaka Goba', location:'Goba', phone:['+255767573607']},
          {name:'Wakaka Kimara', location:'Kimara', phone:['+255762328638']},
          {name:'Wakaka M/Kijichi', location:'Kijichi', phone:['+255712222966']},
          {name:'Wakaka Sinza Madukani', location:'Sinza', phone:['+255622214482']},
          {name:'Wakaka Sinza Kwaremmy', location:'Sinza', phone:['+255713843949']},
          {name:'Wakaka Sinza Mori', location:'Sinza', phone:['+255716913192','+255712222966']},
          {name:'Wakaka Banana', location:'Banana', phone:['+255683064346']},
          {name:'Wakaka Tabata', location:'Tabata', phone:['+255689345159']},
          {name:'Wakaka M/Boni Navisha', location:'M/ Boni', phone:['+255713777501']},
          {name:'Wakaka Africansana', location:'Africansana', phone:['+255763400442']},
          {name:'Wakaka Tanga', location:'Tanga', phone:['+255713843643','+25565622736']},
          {name:'Wakaka Mvomero', location:'Mvomero', phone:['+255754960936']},
          {name:'Wakaka Moshi', location:'Moshi', phone:['+255768000894','+255714456900']},
          {name:'Wakaka Mwenge (alt)', location:'Mwenge', phone:['+255757736910','+255715842472','+255714722358']}
        ];

        // helpers - keep local and small
        function normalizePhone(p){
          if(!p) return '';
          let s = String(p).replace(/[^0-9]/g,'');
          if(s.length === 10 && s[0]==='0') s = '255' + s.slice(1);
          if(s.length === 9) s = '255' + s;
          if(s.length >= 11 && s.indexOf('255')===0) return '+' + s;
          return '+' + s;
        }
        function normalizeAreaName(a){ return (a||'').toString().replace(/[\,\.|\(\)]/g,'').replace(/\s+/g,' ').trim(); }
        function keyForAgent(a){ const name = (a.name||'').toString().toLowerCase().replace(/\s+/g,''); const area = (a.location||a.area||'').toString().toLowerCase().replace(/\s+/g,''); return name + '|' + area; }

        const map = new Map();
        raw.forEach((r,i)=>{
          const phones = (Array.isArray(r.phone)?r.phone:[r.phone||'']).map(normalizePhone).filter(Boolean);
          const area = normalizeAreaName(r.location||r.area||'');
          const name = (r.name||'').toString().trim();
          const id = r.id || (name.toLowerCase().replace(/\s+/g,'_') + '_' + i);
          const entry = { id, name, area, phone: Array.from(new Set(phones)), sourceIndex: i };
          const k = keyForAgent(entry);
          if(map.has(k)){
            const existing = map.get(k);
            existing.phone = Array.from(new Set([].concat(existing.phone||[], entry.phone||[])));
            if(!existing.location && entry.area) existing.location = entry.area;
            if(!existing.name && entry.name) existing.name = entry.name;
          }else{
            map.set(k, entry);
          }
        });

        const cleaned = Array.from(map.values()).map((a,idx)=>({ id: a.id || ('agent_'+idx), name: a.name, location: a.area || a.location, phone: a.phone }));
        agents = cleaned.map((a,i)=>normalizeAgent(a,i));
        try{ localStorage.setItem(AGENTS_KEY, JSON.stringify(cleaned)); }catch(e){}
      }

      // Helper to normalise location strings for matching
      function normalizeLoc(s){ return (s||'').toString().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,''); }

      // Populate location filter based on agents data to ensure relevant options
      function populateLocationFilter(){
        try{
          const locs = Array.from(new Set(agents.map(a=> (a.location||'').trim()).filter(Boolean)));
          // clear existing options and keep 'All Locations'
          locationFilter.innerHTML = '';
          const allOpt = document.createElement('option');
          allOpt.value = 'all'; allOpt.textContent = 'All Locations';
          locationFilter.appendChild(allOpt);
          locs.sort();
          locs.forEach(loc=>{
            const opt = document.createElement('option');
            opt.value = normalizeLoc(loc);
            opt.textContent = loc;
            locationFilter.appendChild(opt);
          });
        }catch(e){ /* ignore */ }
      }

      // DOM Elements
      const communityContainer = document.getElementById('community-container');
      const chatContainer = document.querySelector('.chat-container');
      const chatBox = document.getElementById('chat-box');
      const chatInput = document.getElementById('chat-input');
      const sendBtn = document.getElementById('send-btn');
      const agentListContainer = document.getElementById('agent-list');
      const agentSearch = document.getElementById('agent-search');
      const locationFilter = document.getElementById('location-filter');
      const agentModal = document.getElementById('agent-modal');
      const closeAgentModal = document.getElementById('close-agent-modal');
      const minimizeChatBtn = document.getElementById('minimize-chat');
      const closeChatBtn = document.getElementById('close-chat');

      let selectedAgentId = null;
      let filteredAgents = [...agents];
      let chatMessages = [];

      // Render all agents
      function renderAgents(agentsToRender) {
        agentListContainer.innerHTML = '';
        
        if (agentsToRender.length === 0) {
          agentListContainer.innerHTML = '<p class="no-agents-message">No agents found matching your criteria.</p>';
          return;
        }
        
        agentsToRender.forEach(agent => {
          const agentCard = document.createElement('div');
          agentCard.className = 'agent-card';
          
          const availabilityClass = agent.status === 'Available' ? 'available' : 'unavailable';
          const availabilityText = agent.status === 'Available' ? 'Online' : 'Busy';
          
          agentCard.innerHTML = `
            <div class="agent-avatar">
              <img src="images/logo.png.jpg" alt="Pearl Essence Logo" class="agent-profile-pic">
            </div>
            <div class="agent-details">
              <p class="agent-name">${agent.name}</p>
              <p class="agent-info">${agent.role} &bull; Rating: <span class="agent-rating">${agent.rating} <i class="fas fa-star"></i></span></p>
              <p class="agent-location"><i class="fas fa-map-marker-alt"></i> ${agent.location}</p>
                  <div class="agent-contact">
                    ${agent.phone.map(p=>`<a href="tel:${p}" class="phone-link" aria-label="Call ${agent.name}">${'<i class="fas fa-phone"></i>'}</a>`).join('')}
                  </div>
            </div>
            <span class="agent-availability ${availabilityClass}">${availabilityText}</span>
          `;
          
          // Add click listener to view agent details
          agentCard.addEventListener('click', (e) => {
            if (!e.target.closest('.phone-link')) {
              openAgentModal(agent);
            }
          });
          
          agentListContainer.appendChild(agentCard);
        });
      }

      // Open agent modal
      function openAgentModal(agent) {
        const modal = document.getElementById('agent-modal');
        const modalAvatar = document.getElementById('modal-agent-avatar');
        const modalName = document.getElementById('modal-agent-name');
        const modalRole = document.getElementById('modal-agent-role');
        const modalAvailability = document.getElementById('modal-agent-availability');
        const modalLocation = document.getElementById('modal-agent-location');
        const modalPhone = document.getElementById('modal-agent-phone');
        const modalRating = document.getElementById('modal-agent-rating');
        const modalClients = document.getElementById('modal-agent-clients');
        const modalResponse = document.getElementById('modal-agent-response');
        const modalCallBtn = document.getElementById('modal-call-btn');
        const modalChatBtn = document.getElementById('modal-chat-btn');
        
        modalAvatar.innerHTML = `<img src="images/logo.png.jpg" alt="Pearl Essence Logo">`;
        modalName.textContent = agent.name;
        modalRole.textContent = agent.role;
        modalAvailability.textContent = agent.status;
        modalAvailability.className = `agent-availability ${agent.status === 'Available' ? 'available' : 'unavailable'}`;
        modalLocation.textContent = `Location: ${agent.location}`;
        // Render one or more phone links in the modal so users can choose when multiple numbers exist
        try{
          if(Array.isArray(agent.phone) && agent.phone.length){
            modalPhone.innerHTML = 'Phone: ' + agent.phone.map(p=>`<a href="tel:${p.replace(/\s+/g,'')}">${p}</a>`).join(' &nbsp;•&nbsp; ');
            modalCallBtn.href = `tel:${agent.phone[0].replace(/\s+/g,'')}`;
          }else if(agent.phone){
            modalPhone.innerHTML = `Phone: <a href="tel:${String(agent.phone).replace(/\s+/g,'')}">${agent.phone}</a>`;
            modalCallBtn.href = `tel:${String(agent.phone).replace(/\s+/g,'')}`;
          }else{
            modalPhone.textContent = 'Phone: N/A';
            modalCallBtn.href = '#';
          }
        }catch(err){
          modalPhone.textContent = `Phone: ${agent.phone}`;
        }
  modalRating.textContent = `Rating: ${agent.rating}/5`;
        modalClients.textContent = `Clients served: ${agent.clients}+`;
        modalResponse.textContent = `Avg. response time: ${agent.responseTime}`;
        
        
        modalChatBtn.onclick = () => {
          startChatWithAgent(agent);
          closeAgentModal.click();
        };

        // Login-as-agent button sets pe_current_agent and redirects to agent dashboard (demo flow)
        const modalLoginBtn = document.getElementById('modal-login-btn');
        if(modalLoginBtn){
          modalLoginBtn.onclick = (e)=>{
            e.preventDefault();
            const session = { id: agent.id, name: agent.name, phone: (agent.phone&&agent.phone[0])||'' };
            try{ localStorage.setItem('pe_current_agent', JSON.stringify(session)); }catch(err){}
            // redirect to agent dashboard (demo)
            window.location.href = 'agent-dashboard.html';
          };
        }
        
        modal.style.display = 'flex';
      }

      // Start chat with agent
      function startChatWithAgent(agent) {
        selectedAgentId = agent.id;
        
        // Update chat header
        document.getElementById('chat-agent-avatar').innerHTML = `<img src="images/logo.png.jpg" alt="Pearl Essence Logo">`;
        document.getElementById('chat-agent-name').textContent = agent.name;
        document.getElementById('chat-agent-status').textContent = agent.status;
        
        // Show chat and hide agent list
        communityContainer.style.display = 'none';
        chatContainer.style.display = 'flex';
        
        // Clear chat box
        chatBox.innerHTML = '';
        
        // Add welcome message
        appendMessage('assistant', `Hello! I'm ${agent.name}, your Pearl Essence skincare specialist. How can I help you today?`);
        
        // Focus on input
        setTimeout(() => {
          chatInput.focus();
        }, 100);
      }

      // Append message to chat
      function appendMessage(sender, text) {
        const messageContainer = document.createElement('div');
        messageContainer.className = `message-container ${sender}-message`;
        
        const messageBubble = document.createElement('div');
        messageBubble.className = 'message-bubble';
        messageBubble.textContent = text;

        messageContainer.appendChild(messageBubble);
        chatBox.appendChild(messageContainer);
        chatBox.scrollTop = chatBox.scrollHeight;
        
        // Store message
        chatMessages.push({ sender, text, timestamp: new Date() });
      }

      // Handle chat input
      function handleChat() {
        const userMessage = chatInput.value.trim();
        if (userMessage === '' || !selectedAgentId) return;

        // Add user message
        appendMessage('user', userMessage);
        chatInput.value = '';

        // Simulate agent response after a delay
        setTimeout(() => {
          const responses = [
            "That's a great question! Our Pearl Essence cream works best when applied twice daily.",
            "I'd recommend starting with our basic skincare set to see how your skin responds.",
            "Many of my clients have seen excellent results with that product. Would you like me to tell you more about it?",
            "Based on your skin type, I think our hydrating formula would work best for you.",
            "I can help you with that! When would you like to schedule a consultation?",
            "That product is currently in stock. Would you like me to place an order for you?"
          ];
          
          const randomResponse = responses[Math.floor(Math.random() * responses.length)];
          appendMessage('assistant', randomResponse);
        }, 1000 + Math.random() * 2000); // Random delay between 1-3 seconds
      }

      // Filter agents based on search and location
      function filterAgents() {
        const searchTerm = agentSearch.value.toLowerCase();
        const locationValue = locationFilter.value; // already normalized via populateLocationFilter()
        
        filteredAgents = agents.filter(agent => {
          const matchesSearch = agent.name.toLowerCase().includes(searchTerm) || 
                               agent.role.toLowerCase().includes(searchTerm) ||
                               agent.location.toLowerCase().includes(searchTerm);
          const agentLocNorm = normalizeLoc(agent.location);
          const matchesLocation = locationValue === 'all' || agentLocNorm === locationValue || agentLocNorm.includes(locationValue);
          
          return matchesSearch && matchesLocation;
        });
        
        renderAgents(filteredAgents);
      }

      // Event listeners
      sendBtn.addEventListener('click', handleChat);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          handleChat();
        }
      });

      agentSearch.addEventListener('input', filterAgents);
      locationFilter.addEventListener('change', filterAgents);

      closeAgentModal.addEventListener('click', () => {
        agentModal.style.display = 'none';
      });

      minimizeChatBtn.addEventListener('click', () => {
        chatContainer.style.display = 'none';
        communityContainer.style.display = 'block';
      });

      closeChatBtn.addEventListener('click', () => {
        chatContainer.style.display = 'none';
        communityContainer.style.display = 'block';
        selectedAgentId = null;
        chatMessages = [];
      });

      // Close modal if clicked outside
      window.addEventListener('click', (e) => {
        if (e.target === agentModal) {
          agentModal.style.display = 'none';
        }
      });

  // Populate location filter then render
  try{ populateLocationFilter(); }catch(e){}
  renderAgents(agents);
    });
  </script>
</body>
</html>